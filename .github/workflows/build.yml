name: Build BLE Spam App

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout BLE Spam
      uses: actions/checkout@v4
      
    - name: Clone official firmware
      run: |
        git clone --recursive --depth=1 https://github.com/flipperdevices/flipperzero-firmware.git
        cd flipperzero-firmware
        # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ç–∫—É
        git checkout 0.98.1
        
    - name: Copy BLE Spam to user applications
      run: |
        cd flipperzero-firmware
        mkdir -p applications_user
        cp -r ../. applications_user/ble_spam/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å
        echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ BLE Spam:"
        ls -la applications_user/ble_spam/
        echo ""
        echo "üìã –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        ls -la applications_user/ble_spam/*.c applications_user/ble_spam/*.h applications_user/ble_spam/*.fam 2>/dev/null || true
        
    - name: Build FAP
      run: |
        cd flipperzero-firmware
        ./fbt fap_ble_spam
        
    - name: Find and display build results
      run: |
        cd flipperzero-firmware
        echo "üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏:"
        find . -name "ble_spam.fap" -type f
        echo ""
        echo "üì¶ –í—Å–µ FAP —Ñ–∞–π–ª—ã:"
        find . -name "*.fap" -type f | head -10
        
    - name: Upload FAP artifact
      uses: actions/upload-artifact@v4
      with:
        name: ble-spam-fap
        path: |
          flipperzero-firmware/dist/f7-C/faps/ble_spam.fap
          flipperzero-firmware/build/f7-firmware-D/.extapps/ble_spam.fap
        if-no-files-found: warn
