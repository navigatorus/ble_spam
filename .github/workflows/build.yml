name: Build BLE Spam Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout BLE Spam
      uses: actions/checkout@v4
      
    - name: Clone Official Firmware
      run: |
        git clone --recursive --depth=1 https://github.com/flipperdevices/flipperzero-firmware.git
        cd flipperzero-firmware
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ç–∫—É dev –≤–º–µ—Å—Ç–æ release
        git checkout dev
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget python3 python3-pip cmake build-essential libusb-1.0-0-dev
        cd flipperzero-firmware
        pip3 install -r requirements.txt
        
    - name: Copy BLE Spam to applications
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        mkdir -p flipperzero-firmware/applications/ble_spam
        
        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã BLE Spam
        cp -r assets scenes protocols icons flipperzero-firmware/applications/ble_spam/
        cp ble_spam.c ble_spam.h application.fam ble_spam_10px.png LICENSE.txt flipperzero-firmware/applications/ble_spam/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
        find flipperzero-firmware/applications/ble_spam -name "*.c" -o -name "*.h" | head -10
        
    - name: Build BLE Spam FAP
      run: |
        cd flipperzero-firmware
        ./fbt fap_ble_spam
        
    - name: Find and upload FAP
      run: |
        cd flipperzero-firmware
        echo "üîç –ü–æ–∏—Å–∫ FAP —Ñ–∞–π–ª–æ–≤:"
        find . -name "*.fap" -type f | head -10
        find . -name "ble_spam.fap" -type f
        
    - name: Upload FAP artifact
      uses: actions/upload-artifact@v4
      with:
        name: ble-spam-fap
        path: |
          flipperzero-firmware/build/f7-firmware-D/.extapps/ble_spam.fap
          flipperzero-firmware/dist/f7-C/faps/ble_spam.fap
        if-no-files-found: warn
