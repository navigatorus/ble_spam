name: Build BLE Spam Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout BLE Spam
      uses: actions/checkout@v4
      
    - name: Clone Official Firmware
      run: |
        git clone --recursive --depth=1 https://github.com/flipperdevices/flipperzero-firmware.git
        cd flipperzero-firmware
        git checkout release
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget python3 python3-pip cmake build-essential libusb-1.0-0-dev libncurses5-dev
        cd flipperzero-firmware
        pip3 install -f requirements.txt
        
    - name: Copy BLE Spam to applications
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        mkdir -p flipperzero-firmware/applications/ble_spam
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ BLE Spam
        cp -r assets scenes protocols icons flipperzero-firmware/applications/ble_spam/
        cp ble_spam.c ble_spam.h application.fam ble_spam_10px.png LICENSE.txt flipperzero-firmware/applications/ble_spam/
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
        echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
        find flipperzero-firmware/applications/ble_spam -name "*.c" -o -name "*.h" -o -name "*.fam" | sort
        
    - name: Build BLE Spam FAP
      run: |
        cd flipperzero-firmware
        ./fbt fap_ble_spam
        
    - name: Find built FAP file
      run: |
        cd flipperzero-firmware
        echo "ðŸ” ÐŸÐ¾Ð¸ÑÐº ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ FAP Ñ„Ð°Ð¹Ð»Ð°:"
        find . -name "ble_spam.fap" -type f 2>/dev/null || echo "FAP Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        find . -name "*.fap" -type f | head -10
        
    - name: Upload FAP artifact
      uses: actions/upload-artifact@v4
      with:
        name: ble-spam-fap
        path: |
          flipperzero-firmware/build/f7-firmware-D/.extapps/ble_spam.fap
          flipperzero-firmware/dist/f7-C/faps/ble_spam.fap
        if-no-files-found: warn
        
    - name: Upload source files for debug
      uses: actions/upload-artifact@v4
      with:
        name: ble-spam-source
        path: |
          flipperzero-firmware/applications/ble_spam/
        if-no-files-found: error
