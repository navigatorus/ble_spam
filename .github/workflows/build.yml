name: Build BLE Spam with Unleashed

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout BLE Spam
      uses: actions/checkout@v4
      
    - name: Clone Unleashed Firmware
      run: |
        git clone --recursive --depth=1 https://github.com/DarkFlippers/unleashed-firmware.git
        cd unleashed-firmware
        git checkout dev
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget python3 python3-pip cmake build-essential libusb-1.0-0-dev
        cd unleashed-firmware
        # Устанавливаем зависимости вручную
        pip3 install protobuf pyelftools ansi
        
    - name: Copy and adapt BLE Spam
      run: |
        # Создаем папку для приложения
        mkdir -p unleashed-firmware/applications_user/ble_spam
        
        # Копируем файлы
        cp -r assets scenes protocols icons unleashed-firmware/applications_user/ble_spam/
        cp ble_spam.c ble_spam.h application.fam ble_spam_10px.png LICENSE.txt unleashed-firmware/applications_user/ble_spam/
        
        # Создаем упрощенный application.fam для Unleashed
        cat > unleashed-firmware/applications_user/ble_spam/application.fam << 'EOF'
App(
    appid="ble_spam",
    name="BLE Spam",
    apptype=FlipperAppType.EXTERNAL,
    entry_point="ble_spam_app",
    stack_size=2*1024,
    icon="ble_spam_10px.png",
)
EOF
        
        echo "📁 Структура:"
        ls -la unleashed-firmware/applications_user/ble_spam/
        
    - name: Build BLE Spam
      run: |
        cd unleashed-firmware
        ./fbt fap_ble_spam
        
    - name: Upload FAP
      uses: actions/upload-artifact@v4
      with:
        name: ble-spam-unleashed
        path: unleashed-firmware/dist/f7-C/faps/ble_spam.fap
        if-no-files-found: warn
